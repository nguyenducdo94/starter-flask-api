<!DOCTYPE html>
<html>

<head>
    <title>Facebook Check New Post</title>
    <link rel="stylesheet" type="text/css" href="/static/main.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.css">
</head>

<body>
    <div class="user-info">
        {% if current_user.is_authenticated %}
        <p>Xin ch√†o, {{ current_user.username }}! (<a href="{{ url_for('logout') }}">Logout</a>)</p>
        {% else %}
        <p>B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p.</p>
        {% endif %}
    </div>
    <h1><a href="/" class="home-link">ONLINE TOOL</a> > <a href="/facebook" class="facebook-link">FACEBOOK</a> > TH√îNG
        B√ÅO B√ÄI VI·∫æT M·ªöI</h1>

    {% if schedules %}
    <div class="account-table">
        <table>
            <thead>
                <tr>
                    <th>T√™n T√†i kho·∫£n</th>
                    <th>Token</th>
                    <th>Cookie</th>
                    <th>Group ID</th>
                    <th>Tr·∫°ng Th√°i</th>
                </tr>
            </thead>
            <tbody>
                {% for schedule in schedules %}
                <tr>
                    <td title="{{ account.name }}">
                        {{ account.name|truncate(20, true, '...') }}
                    </td>
                    <td title="{{ account.token }}">
                        {{ account.token|truncate(20, true, '...') }}
                        <span class="copy" onclick="copyText('{{ account.token}}')">üìã</span>
                    </td>
                    <td title="{{ account.cookie }}">
                        {{ account.cookie|truncate(20, true, '...') }}
                        <span class="copy" onclick="copyText('{{ account.cookie}}')">üìã</span>
                    </td>
                    <td>
                        <button
                            onclick="openEditModal({ '_id': '{{ account._id }}','name': '{{ account.name }}', 'token': '{{ account.token }}', 'cookie': '{{ account.cookie }}' })">S·ª≠a</button>
                        <button onclick="openDeleteConfirmModal('{{ account._id }}')">Xo√°</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p>Ch∆∞a c√≥ nhi·ªám v·ª• n√†o.</p>
    {% endif %}

    <!-- Button m·ªü Form Th√™m T√†i kho·∫£n -->
    <button id="add-button" onclick="openAddModal()">Th√™m Nhi·ªám v·ª•</button>

    <!-- Modal Th√™m T√†i kho·∫£n -->
    <div id="add-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddModal()">&times;</span>
            <h2>Th√™m Nhi·ªám v·ª•</h2>
            <label for="account-select">Ch·ªçn T√†i kho·∫£n:</label>
            <select id="account-select"></select>
            <label for="group-id">Group ID:</label>
            <input type="text" id="group-id">
            <button onclick="addNewSchedule()">L∆∞u</button>
        </div>
    </div>

    <!-- Modal Xo√° T√†i kho·∫£n -->
    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content">
            <h2>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i kho·∫£n n√†y?</h2>
            <button data-account-id="" id="delete-confirm-yes" onclick="deleteAccountConfirmed()">C√≥</button>
            <button style="margin-top: 10px;" onclick="closeDeleteConfirmModal()">Kh√¥ng</button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            fetch('/facebook/get_owner_facebook_accounts')
                .then(response => response.json())
                .then(data => {
                    const accountSelect = document.getElementById("account-select");

                    // L·∫∑p qua danh s√°ch t√†i kho·∫£n v√† th√™m m·ªói t√†i kho·∫£n v√†o select
                    data.forEach(account => {
                        const option = document.createElement("option");
                        option.value = account._id;
                        option.text = account.name;

                        accountSelect.appendChild(option);
                    });
                })
                .catch(error => console.error("L·ªói khi t·∫£i danh s√°ch t√†i kho·∫£n:", error));
        });

        function openAddModal() {
            document.getElementById('add-modal').style.display = 'block';
        }

        function closeAddModal() {
            document.getElementById('add-modal').style.display = 'none';
        }

        function openDeleteConfirmModal(accountId) {
            document.getElementById('delete-confirm-yes').setAttribute('data-account-id', accountId);
            document.getElementById('delete-confirm-modal').style.display = 'block';
        }

        function closeDeleteConfirmModal() {
            document.getElementById('delete-confirm-modal').style.display = 'none';
        }

        function addNewAccount() {
            const accountName = document.getElementById('new-account-name').value;
            const accountToken = document.getElementById('new-account-token').value;
            const accountCookie = document.getElementById('new-account-cookie').value;

            if (accountName && accountToken && accountCookie) {
                closeAddModal()
                // G·ª≠i th√¥ng tin t√†i kho·∫£n m·ªõi ƒë·∫øn m√°y ch·ªß
                fetch('/facebook/add_account', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: accountName,
                        token: accountToken,
                        cookie: accountCookie
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        // Ki·ªÉm tra k·∫øt qu·∫£ v√† x·ª≠ l√Ω t∆∞∆°ng ·ª©ng
                        if (data.success) {
                            // ƒê√£ th√™m th√†nh c√¥ng
                            Toastify({
                                text: 'T√†i kho·∫£n ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng.',
                                duration: 3000,  // Th·ªùi gian hi·ªÉn th·ªã (3 gi√¢y)
                                close: true,
                                gravity: 'top',  // V·ªã tr√≠ hi·ªÉn th·ªã
                                position: 'center',  // V·ªã tr√≠ toast
                            }).showToast();

                            // ƒê·ª£i 2 gi√¢y tr∆∞·ªõc khi l√†m m·ªõi trang
                            setTimeout(() => {
                                window.location.reload();
                            }, 2000);
                        } else {
                            // X·ª≠ l√Ω l·ªói (n·∫øu c√≥)
                            Toastify({
                                text: `ƒê√£ x·∫£y ra l·ªói khi c·∫≠p nh·∫≠t t√†i kho·∫£n: ${data.error}`,
                                duration: 3000,
                                close: true,
                                gravity: 'top',
                                position: 'center',
                            }).showToast();
                        }
                    })
                    .catch(error => {
                        console.error('L·ªói:', error);
                        Toastify({
                            text: 'ƒê√£ x·∫£y ra l·ªói khi th√™m t√†i kho·∫£n.',
                            duration: 3000,
                            close: true,
                            gravity: 'top',
                            position: 'center',
                        }).showToast();
                    });
            } else {
                Toastify({
                    text: 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin t√†i kho·∫£n.',
                    duration: 3000,
                    close: true,
                    gravity: 'top',
                    position: 'center',
                }).showToast();
            }
        }

        function deleteAccountConfirmed() {
            const accountId = document.getElementById('delete-confirm-yes').getAttribute('data-account-id');

            closeDeleteConfirmModal()

            fetch(`/facebook/delete_account/${accountId}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // X√≥a th√†nh c√¥ng
                        Toastify({
                            text: 'T√†i kho·∫£n ƒë√£ ƒë∆∞·ª£c xo√° th√†nh c√¥ng.',
                            duration: 3000,  // Th·ªùi gian hi·ªÉn th·ªã (3 gi√¢y)
                            close: true,
                            gravity: 'top',  // V·ªã tr√≠ hi·ªÉn th·ªã
                            position: 'center',  // V·ªã tr√≠ toast
                        }).showToast();

                        // ƒê·ª£i 2 gi√¢y tr∆∞·ªõc khi l√†m m·ªõi trang
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        console.error('L·ªói:', error);
                        Toastify({
                            text: `ƒê√£ x·∫£y ra l·ªói khi c·∫≠p nh·∫≠t t√†i kho·∫£n: ${data.error}`,
                            duration: 3000,
                            close: true,
                            gravity: 'top',
                            position: 'center',
                        }).showToast();
                    }
                })
                .catch(error => {
                    console.error('L·ªói:', error);
                    Toastify({
                        text: 'ƒê√£ x·∫£y ra l·ªói khi xo√° t√†i kho·∫£n.',
                        duration: 3000,
                        close: true,
                        gravity: 'top',
                        position: 'center',
                    }).showToast();
                });
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</body>

</html>