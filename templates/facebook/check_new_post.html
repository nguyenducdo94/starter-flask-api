<!DOCTYPE html>
<html>

<head>
    <title>Facebook Check New Post</title>
    <link rel="stylesheet" type="text/css" href="/static/main.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.css">
</head>

<body>
    <div class="user-info">
        {% if current_user.is_authenticated %}
        <p>Xin ch√†o, {{ current_user.username }}! (<a href="{{ url_for('logout') }}">Logout</a>)</p>
        {% else %}
        <p>B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p.</p>
        {% endif %}
    </div>
    <h1><a href="/" class="home-link">ONLINE TOOL</a> > <a href="/facebook" class="facebook-link">FACEBOOK</a> > TH√îNG
        B√ÅO B√ÄI VI·∫æT M·ªöI</h1>

    {% if schedules %}
    <div class="schedule-table">
        <table>
            <thead>
                <tr>
                    <th>T√™n T√†i kho·∫£n</th>
                    <th>Token</th>
                    <th>Cookie</th>
                    <th>Group ID</th>
                    <th>T·∫ßn s·ªë qu√©t</th>
                    <th>Tr·∫°ng Th√°i</th>
                </tr>
            </thead>
            <tbody>
                {% for schedule in schedules %}
                <tr>
                    <td title="{{ schedule.account_name }}">
                        {{ schedule.account_name|truncate(20, true, '...') }}
                    </td>
                    <td title="{{ schedule.account_token }}">
                        {% if schedule.account_token|length > 0 %}
                        {{ schedule.account_token|truncate(20, true, '...') }}
                        <span class="copy" onclick="copyText('{{ schedule.account_token}}')">üìã</span>
                        {% endif %}
                    </td>
                    <td title="{{ schedule.account_cookie }}">
                        {% if schedule.account_cookie|length > 0 %}
                        {{ schedule.account_cookie|truncate(20, true, '...') }}
                        <span class="copy" onclick="copyText('{{ schedule.account_cookie}}')">üìã</span>
                        {% endif %}
                    </td>
                    <td title="{{ schedule.group_id }}">
                        {{ schedule.group_id|truncate(20, true, '...') }}
                    </td>
                    <td title="{{ schedule.interval }}">
                        {{ schedule.interval }} (gi√¢y)
                    </td>
                    <td title="{{ schedule.active }}" id="schedule-toggle-{{ schedule.sk }}">
                        <label class="toggle-switch">
                            <input type="checkbox" {% if schedule.active %}checked{% endif %}
                                onclick="toggleSchedule('{{ schedule.sk }}')">
                            <span class="toggle-slider"></span>
                        </label>
                    </td>
                    <td>
                        <button onclick="openStartConfirmModal('{{ schedule.sk }}')">B·∫Øt ƒë·∫ßu</button>
                        <button onclick="openDeleteConfirmModal('{{ schedule.sk }}')">Xo√°</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p>Ch∆∞a c√≥ nhi·ªám v·ª• n√†o.</p>
    {% endif %}

    <!-- Button m·ªü Form Th√™m T√†i kho·∫£n -->
    <button id="add-button" onclick="openAddModal()">Th√™m Nhi·ªám v·ª•</button>

    <!-- Modal Th√™m T√†i kho·∫£n -->
    <div id="add-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddModal()">&times;</span>
            <h2>Th√™m Nhi·ªám v·ª•</h2>
            <label for="account-select">Ch·ªçn T√†i kho·∫£n:</label>
            <select id="account-select"></select>
            <label for="group-id">Group ID:</label>
            <input type="text" id="group-id">
            <label for="interval">T·∫ßn s·ªë qu√©t (gi√¢y):</label>
            <input type="text" id="interval">
            <button onclick="addNewSchedule()">L∆∞u</button>
        </div>
    </div>

    <!-- Modal Xo√° T√†i kho·∫£n -->
    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content">
            <h2>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a nhi·ªám v·ª• n√†y?</h2>
            <button data-schedule-id="" id="delete-confirm-yes" onclick="deleteScheduleConfirmed()">C√≥</button>
            <button style="margin-top: 10px;" onclick="closeDeleteConfirmModal()">Kh√¥ng</button>
        </div>
    </div>

    <!-- Modal Start Schedule -->
    <div id="start-confirm-modal" class="modal">
        <div class="modal-content">
            <h2>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën b·∫Øt ƒë·∫ßu nhi·ªám v·ª• n√†y?</h2>
            <button data-schedule-id="" id="start-confirm-yes" onclick="startScheduleConfirmed()">C√≥</button>
            <button style="margin-top: 10px;" onclick="closeStartConfirmModal()">Kh√¥ng</button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            fetch('/facebook/accountmanager/get_owner_facebook_accounts')
                .then(response => response.json())
                .then(data => {
                    const accountSelect = document.getElementById("account-select");

                    // L·∫∑p qua danh s√°ch t√†i kho·∫£n v√† th√™m m·ªói t√†i kho·∫£n v√†o select
                    data.forEach(account => {
                        const option = document.createElement("option");
                        option.value = account.sk;
                        option.text = account.account_name;

                        accountSelect.appendChild(option);
                    });
                })
                .catch(error => console.error("L·ªói khi t·∫£i danh s√°ch t√†i kho·∫£n:", error));
        });

        function openAddModal() {
            document.getElementById('add-modal').style.display = 'block';
        }

        function closeAddModal() {
            document.getElementById('add-modal').style.display = 'none';
        }

        function openDeleteConfirmModal(scheduleId) {
            document.getElementById('delete-confirm-yes').setAttribute('data-schedule-id', scheduleId);
            document.getElementById('delete-confirm-modal').style.display = 'block';
        }

        function closeDeleteConfirmModal() {
            document.getElementById('delete-confirm-modal').style.display = 'none';
        }

        function openStartConfirmModal(scheduleId) {
            document.getElementById('start-confirm-yes').setAttribute('data-schedule-id', scheduleId);
            document.getElementById('start-confirm-modal').style.display = 'block';
        }

        function closeStartConfirmModal() {
            document.getElementById('start-confirm-modal').style.display = 'none';
        }

        function addNewSchedule() {
            const accountId = document.getElementById('account-select').value;
            const groupId = document.getElementById('group-id').value;
            const interval = document.getElementById('interval').value;

            if (accountId && groupId) {
                closeAddModal()
                // G·ª≠i th√¥ng tin t√†i kho·∫£n m·ªõi ƒë·∫øn m√°y ch·ªß
                fetch('/facebook/checknewpost/add_schedule', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        account_id: accountId,
                        group_id: groupId,
                        interval: interval
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        // Ki·ªÉm tra k·∫øt qu·∫£ v√† x·ª≠ l√Ω t∆∞∆°ng ·ª©ng
                        if (data.success) {
                            // ƒê√£ th√™m th√†nh c√¥ng
                            Toastify({
                                text: 'Nhi·ªám v·ª• ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng.',
                                duration: 3000,  // Th·ªùi gian hi·ªÉn th·ªã (3 gi√¢y)
                                close: true,
                                gravity: 'top',  // V·ªã tr√≠ hi·ªÉn th·ªã
                                position: 'center',  // V·ªã tr√≠ toast
                            }).showToast();

                            // ƒê·ª£i 2 gi√¢y tr∆∞·ªõc khi l√†m m·ªõi trang
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        } else {
                            // X·ª≠ l√Ω l·ªói (n·∫øu c√≥)
                            Toastify({
                                text: `ƒê√£ x·∫£y ra l·ªói khi th√™m nhi·ªám v·ª•: ${data.error}`,
                                duration: 3000,
                                close: true,
                                gravity: 'top',
                                position: 'center',
                            }).showToast();
                        }
                    })
                    .catch(error => {
                        console.error('L·ªói:', error);
                        Toastify({
                            text: 'ƒê√£ x·∫£y ra l·ªói khi th√™m nhi·ªám v·ª•.',
                            duration: 3000,
                            close: true,
                            gravity: 'top',
                            position: 'center',
                        }).showToast();
                    });
            } else {
                Toastify({
                    text: 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin nhi·ªám v·ª•.',
                    duration: 3000,
                    close: true,
                    gravity: 'top',
                    position: 'center',
                }).showToast();
            }
        }

        function deleteScheduleConfirmed() {
            const scheduleId = document.getElementById('delete-confirm-yes').getAttribute('data-schedule-id');

            closeDeleteConfirmModal()

            fetch(`/facebook/checknewpost/delete_schedule/${scheduleId}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // X√≥a th√†nh c√¥ng
                        Toastify({
                            text: 'ƒê√£ xo√° nhi·ªám v·ª•.',
                            duration: 3000,  // Th·ªùi gian hi·ªÉn th·ªã (3 gi√¢y)
                            close: true,
                            gravity: 'top',  // V·ªã tr√≠ hi·ªÉn th·ªã
                            position: 'center',  // V·ªã tr√≠ toast
                        }).showToast();

                        // ƒê·ª£i 2 gi√¢y tr∆∞·ªõc khi l√†m m·ªõi trang
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        console.error('L·ªói:', error);
                        Toastify({
                            text: `ƒê√£ x·∫£y ra l·ªói khi xo√° nhi·ªám v·ª•: ${data.error}`,
                            duration: 3000,
                            close: true,
                            gravity: 'top',
                            position: 'center',
                        }).showToast();
                    }
                })
                .catch(error => {
                    console.error('L·ªói:', error);
                    Toastify({
                        text: 'ƒê√£ x·∫£y ra l·ªói khi xo√° nhi·ªám v·ª•.',
                        duration: 3000,
                        close: true,
                        gravity: 'top',
                        position: 'center',
                    }).showToast();
                });
        }

        function startScheduleConfirmed() {
            const scheduleId = document.getElementById('start-confirm-yes').getAttribute('data-schedule-id');

            closeStartConfirmModal()

            fetch(`/facebook/checknewpost/start_schedule`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    scheduleId: scheduleId
                })
            })
        }


        function toggleSchedule(scheduleId) {
            // L·∫•y tr·∫°ng th√°i hi·ªán t·∫°i c·ªßa toggle switch
            const checkbox = document.getElementById(`schedule-toggle-${scheduleId}`).querySelector('input[type="checkbox"]');
            const isActive = checkbox.checked;

            const newStatus = isActive;

            fetch('/facebook/checknewpost/toggle_schedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ newStatus: newStatus, scheduleId: scheduleId }),
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // X·ª≠ l√Ω ph·∫£n h·ªìi t·ª´ m√°y ch·ªß (n·∫øu c·∫ßn)
                    console.log('Update successful:', data);
                })
                .catch(error => {
                    // X·ª≠ l√Ω l·ªói (n·∫øu c√≥)
                    console.error('Update failed:', error);
                });
        }


        function copyText(content) {
            const textArea = document.createElement("textarea");
            textArea.value = content;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</body>

</html>