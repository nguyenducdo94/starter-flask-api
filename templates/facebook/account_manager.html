<!DOCTYPE html>
<html>

<head>
    <title>Facebook Account Manager</title>
    <link rel="stylesheet" type="text/css" href="/static/main.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.css">
</head>

<body>
    <div class="user-info">
        {% if current_user.is_authenticated %}
        <p>Xin ch√†o, {{ current_user.username }}! (<a href="{{ url_for('logout') }}">Logout</a>)</p>
        {% else %}
        <p>B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p.</p>
        {% endif %}
    </div>
    <h1><a href="/" class="home-link">ONLINE TOOL</a> > <a href="/facebook" class="facebook-link">FACEBOOK</a> > QU·∫¢N L√ù
        T√ÄI KHO·∫¢N</h1>

    {% if accounts %}
    <div class="account-table">
        <table>
            <thead>
                <tr>
                    <th>T√™n T√†i kho·∫£n</th>
                    <th>Token</th>
                    <th>Cookie</th>
                    <th>Thao t√°c</th>
                </tr>
            </thead>
            <tbody>
                {% for account in accounts %}
                <tr>
                    <td title="{{ account.account_name }}">
                        {{ account.account_name|truncate(20, true, '...') }}
                    </td>
                    <td title="{{ account.account_token }}">
                        {{ account.account_token|truncate(20, true, '...') }}
                        <span class="copy" onclick="copyText('{{ account.account_token}}')">üìã</span>
                    </td>
                    <td title="{{ account.account_cookie }}">
                        {{ account.account_cookie|truncate(20, true, '...') }}
                        <span class="copy" onclick="copyText('{{ account.account_cookie}}')">üìã</span>
                    </td>
                    <td>
                        <button
                            onclick="openEditModal({ 'sk': '{{ account.sk }}','account_name': '{{ account.account_name }}', 'account_token': '{{ account.account_token }}', 'account_cookie': '{{ account.account_cookie }}' })">S·ª≠a</button>
                        <button onclick="openDeleteConfirmModal('{{ account.sk }}')">Xo√°</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p>Ch∆∞a c√≥ t√†i kho·∫£n n√†o.</p>
    {% endif %}

    <!-- Button m·ªü Form Th√™m T√†i kho·∫£n -->
    <button id="add-button" onclick="openAddModal()">Th√™m T√†i kho·∫£n</button>

    <!-- Modal S·ª≠a T√†i kho·∫£n -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2>S·ª≠a T√†i kho·∫£n</h2>
            <label for="edit-account-name">T√™n T√†i kho·∫£n:</label>
            <input type="text" id="edit-account-name">
            <label for="edit-account-token">Token:</label>
            <input type="text" id="edit-account-token">
            <label for="edit-account-cookie">Cookie:</label>
            <input type="text" id="edit-account-cookie">
            <button data-account-id="" id="edit-save-btn" onclick="saveEdit()">L∆∞u</button>
        </div>
    </div>

    <!-- Modal Th√™m T√†i kho·∫£n -->
    <div id="add-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddModal()">&times;</span>
            <h2>Th√™m T√†i kho·∫£n</h2>
            <label for="new-account-name">T√™n T√†i kho·∫£n:</label>
            <input type="text" id="new-account-name">
            <label for="new-account-token">Token:</label>
            <input type="text" id="new-account-token">
            <label for="new-account-cookie">Cookie:</label>
            <input type="text" id="new-account-cookie">
            <button onclick="addNewAccount()">L∆∞u</button>
        </div>
    </div>

    <!-- Modal Xo√° T√†i kho·∫£n -->
    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content">
            <h2>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i kho·∫£n n√†y?</h2>
            <button data-account-id="" id="delete-confirm-yes" onclick="deleteAccountConfirmed()">C√≥</button>
            <button style="margin-top: 10px;" onclick="closeDeleteConfirmModal()">Kh√¥ng</button>
        </div>
    </div>

    <script>
        function openEditModal(account) {
            const myButton = document.getElementById('edit-save-btn');
            myButton.setAttribute('data-account-id', account.sk);

            // L·∫•y th·∫ª modal "S·ª≠a T√†i kho·∫£n"
            const editModal = document.getElementById('edit-modal');

            // L·∫•y c√°c tr∆∞·ªùng nh·∫≠p d·ªØ li·ªáu trong modal
            const editAccountName = document.getElementById('edit-account-name');
            const editAccountToken = document.getElementById('edit-account-token');
            const editAccountCookie = document.getElementById('edit-account-cookie');

            // ƒê∆∞a th√¥ng tin t√†i kho·∫£n c·∫ßn ch·ªânh s·ª≠a v√†o c√°c tr∆∞·ªùng nh·∫≠p d·ªØ li·ªáu
            editAccountName.value = account.account_name;
            editAccountToken.value = account.account_token;
            editAccountCookie.value = account.account_cookie;

            // Hi·ªÉn th·ªã modal b·∫±ng c√°ch ƒë·∫∑t thu·ªôc t√≠nh style.display th√†nh 'block'
            editModal.style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        function openAddModal() {
            document.getElementById('add-modal').style.display = 'block';
        }

        function closeAddModal() {
            document.getElementById('add-modal').style.display = 'none';
        }

        function openDeleteConfirmModal(accountId) {
            document.getElementById('delete-confirm-yes').setAttribute('data-account-id', accountId);
            document.getElementById('delete-confirm-modal').style.display = 'block';
        }

        function closeDeleteConfirmModal() {
            document.getElementById('delete-confirm-modal').style.display = 'none';
        }

        function addNewAccount() {
            const accountName = document.getElementById('new-account-name').value;
            const accountToken = document.getElementById('new-account-token').value;
            const accountCookie = document.getElementById('new-account-cookie').value;

            if (accountName && accountToken && accountCookie) {
                closeAddModal()
                // G·ª≠i th√¥ng tin t√†i kho·∫£n m·ªõi ƒë·∫øn m√°y ch·ªß
                fetch('/facebook/accountmanager/add_account', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        account_name: accountName,
                        account_token: accountToken,
                        account_cookie: accountCookie
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        // Ki·ªÉm tra k·∫øt qu·∫£ v√† x·ª≠ l√Ω t∆∞∆°ng ·ª©ng
                        if (data.success) {
                            // ƒê√£ th√™m th√†nh c√¥ng
                            Toastify({
                                text: 'T√†i kho·∫£n ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng.',
                                duration: 3000,  // Th·ªùi gian hi·ªÉn th·ªã (3 gi√¢y)
                                close: true,
                                gravity: 'top',  // V·ªã tr√≠ hi·ªÉn th·ªã
                                position: 'center',  // V·ªã tr√≠ toast
                            }).showToast();

                            // ƒê·ª£i 2 gi√¢y tr∆∞·ªõc khi l√†m m·ªõi trang
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        } else {
                            // X·ª≠ l√Ω l·ªói (n·∫øu c√≥)
                            Toastify({
                                text: `ƒê√£ x·∫£y ra l·ªói khi c·∫≠p nh·∫≠t t√†i kho·∫£n: ${data.error}`,
                                duration: 3000,
                                close: true,
                                gravity: 'top',
                                position: 'center',
                            }).showToast();
                        }
                    })
                    .catch(error => {
                        console.error('L·ªói:', error);
                        Toastify({
                            text: 'ƒê√£ x·∫£y ra l·ªói khi th√™m t√†i kho·∫£n.',
                            duration: 3000,
                            close: true,
                            gravity: 'top',
                            position: 'center',
                        }).showToast();
                    });
            } else {
                Toastify({
                    text: 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin t√†i kho·∫£n.',
                    duration: 3000,
                    close: true,
                    gravity: 'top',
                    position: 'center',
                }).showToast();
            }
        }

        function saveEdit() {
            const accountId = document.getElementById('edit-save-btn').getAttribute('data-account-id');
            const accountName = document.getElementById('edit-account-name').value;
            const accountToken = document.getElementById('edit-account-token').value;
            const accountCookie = document.getElementById('edit-account-cookie').value;

            if (accountName && accountToken && accountCookie) {

                closeEditModal()
                // G·ª≠i th√¥ng tin c·∫≠p nh·∫≠t t√†i kho·∫£n ƒë·∫øn m√°y ch·ªß
                fetch(`/facebook/accountmanager/update_account`, {
                    method: 'PUT', // Ho·∫∑c 'PATCH' n·∫øu b·∫°n mu·ªën s·ª≠ d·ª•ng ph∆∞∆°ng th·ª©c PATCH
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: accountId,
                        account_name: accountName,
                        account_token: accountToken,
                        account_cookie: accountCookie
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        // Ki·ªÉm tra k·∫øt qu·∫£ v√† x·ª≠ l√Ω t∆∞∆°ng ·ª©ng
                        if (data.success) {
                            // ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng
                            Toastify({
                                text: 'T√†i kho·∫£n ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng.',
                                duration: 3000,  // Th·ªùi gian hi·ªÉn th·ªã (3 gi√¢y)
                                close: true,
                                gravity: 'top',  // V·ªã tr√≠ hi·ªÉn th·ªã
                                position: 'center',  // V·ªã tr√≠ toast
                            }).showToast();

                            // ƒê·ª£i 2 gi√¢y tr∆∞·ªõc khi l√†m m·ªõi trang (ho·∫∑c th·ª±c hi·ªán c√°c h√†nh ƒë·ªông kh√°c)
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        } else {
                            // X·ª≠ l√Ω l·ªói (n·∫øu c√≥)
                            Toastify({
                                text: `ƒê√£ x·∫£y ra l·ªói khi c·∫≠p nh·∫≠t t√†i kho·∫£n: ${data.error}`,
                                duration: 3000,
                                close: true,
                                gravity: 'top',
                                position: 'center',
                            }).showToast();
                        }
                    })
                    .catch(error => {
                        console.error('L·ªói:', error);
                        Toastify({
                            text: 'ƒê√£ x·∫£y ra l·ªói khi c·∫≠p nh·∫≠t t√†i kho·∫£n.',
                            duration: 3000,
                            close: true,
                            gravity: 'top',
                            position: 'center',
                        }).showToast();
                    });
            } else {
                Toastify({
                    text: 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin t√†i kho·∫£n.',
                    duration: 3000,
                    close: true,
                    gravity: 'top',
                    position: 'center',
                }).showToast();
            }
        }

        function deleteAccountConfirmed() {
            const accountId = document.getElementById('delete-confirm-yes').getAttribute('data-account-id');

            closeDeleteConfirmModal()

            fetch(`/facebook/accountmanager/delete_account/${accountId}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // X√≥a th√†nh c√¥ng
                        Toastify({
                            text: 'T√†i kho·∫£n ƒë√£ ƒë∆∞·ª£c xo√° th√†nh c√¥ng.',
                            duration: 3000,  // Th·ªùi gian hi·ªÉn th·ªã (3 gi√¢y)
                            close: true,
                            gravity: 'top',  // V·ªã tr√≠ hi·ªÉn th·ªã
                            position: 'center',  // V·ªã tr√≠ toast
                        }).showToast();

                        // ƒê·ª£i 2 gi√¢y tr∆∞·ªõc khi l√†m m·ªõi trang
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        console.error('L·ªói:', error);
                        Toastify({
                            text: `ƒê√£ x·∫£y ra l·ªói khi c·∫≠p nh·∫≠t t√†i kho·∫£n: ${data.error}`,
                            duration: 3000,
                            close: true,
                            gravity: 'top',
                            position: 'center',
                        }).showToast();
                    }
                })
                .catch(error => {
                    console.error('L·ªói:', error);
                    Toastify({
                        text: 'ƒê√£ x·∫£y ra l·ªói khi xo√° t√†i kho·∫£n.',
                        duration: 3000,
                        close: true,
                        gravity: 'top',
                        position: 'center',
                    }).showToast();
                });
        }

        function copyText(content) {
            const textArea = document.createElement("textarea");
            textArea.value = content;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</body>

</html>